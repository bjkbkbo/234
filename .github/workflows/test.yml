name: test

on:
  push:
    paths:
      - ".github/workflows/test.yml"
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Cloudflared
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $cloudflaredUrl = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          curl.exe -fL --retry 3 --retry-all-errors -o cloudflared.exe $cloudflaredUrl

          .\cloudflared.exe --version

      - name: Enable RDP and configure Administrator
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          # 启用远程桌面
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # 查找实际的 Administrator 账户（可能被重命名）
          $adminSid = "S-1-5-21-*-500"
          $adminUser = Get-LocalUser | Where-Object { $_.SID -like $adminSid } | Select-Object -First 1

          if ($adminUser) {
            $adminName = $adminUser.Name
            Write-Host "Found built-in Administrator (SID ends with -500): $adminName"

            if ($adminUser.Enabled -eq $false) {
              Enable-LocalUser -Name $adminName
              Write-Host "Enabled $adminName."
            }

            # 设置密码（使用 PowerShell cmdlet 避免 net user 失败）
            $securePass = ConvertTo-SecureString "test" -AsPlainText -Force
            Set-LocalUser -Name $adminName -Password $securePass -ErrorAction SilentlyContinue
            if ($?) {
              Write-Host "Password set for $adminName via Set-LocalUser."
            } else {
              Write-Host "Note: Set-LocalUser failed (maybe password policy). Trying net user as fallback."
              net user $adminName test 2>$null
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Password set via net user."
              }
            }
          } else {
            Write-Host "Built-in Administrator not found (unexpected). Creating a new local admin."
            $newAdmin = "RunnerAdmin"
            $password = ConvertTo-SecureString "test" -AsPlainText -Force
            New-LocalUser -Name $newAdmin -Password $password -AccountNeverExpires -PasswordNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $newAdmin
            Write-Host "Created new admin: $newAdmin"
          }

          # 确认 RDP 服务已启动
          Start-Service TermService -ErrorAction SilentlyContinue
          Get-Service TermService | Select-Object Name, Status

      - name: Start Cloudflared tunnel (RDP 3389) and print tunnel info
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          # 生成随机隧道名
          $tunnelName = "rdp-$([Guid]::NewGuid().ToString('N').Substring(0,8))"

          # 先运行一次 cloudflared tunnel info 查看现有隧道（可选）
          Write-Host "Existing tunnels (if any):"
          .\cloudflared.exe tunnel list 2>&1 | Out-Host

          # 启动隧道（后台运行）
          Start-Process -FilePath ".\cloudflared.exe" `
            -ArgumentList "tunnel", "--url", "tcp://localhost:3389", "--name", $tunnelName `
            -NoNewWindow `
            -RedirectStandardOutput "cloudflared.out.log" `
            -RedirectStandardError "cloudflared.err.log"

          Start-Sleep -Seconds 8

          # 检查进程
          $p = Get-Process cloudflared -ErrorAction SilentlyContinue
          if (-not $p) {
            Write-Host "Cloudflared failed to start"
            if (Test-Path cloudflared.out.log) { Get-Content cloudflared.out.log -Tail 200 }
            if (Test-Path cloudflared.err.log) { Get-Content cloudflared.err.log -Tail 200 }
            exit 1
          }

          Write-Host "Cloudflared tunnel started (pid=$($p.Id), name=$tunnelName)."
          Write-Host "Tunnel logs: cloudflared.out.log / cloudflared.err.log"

          # 尝试获取隧道详细信息（需要 cloudflared 已认证）
          Write-Host "`n=== 隧道信息 ==="
          .\cloudflared.exe tunnel info --name $tunnelName 2>&1 | Out-Host

          # 输出连接提示（需要用户手动运行 cloudflared access 或使用 dashboard）
          Write-Host "`n=== 连接说明 ==="
          Write-Host "1. 在另一台机器安装 cloudflared"
          Write-Host "2. 运行: cloudflared access tcp --hostname $tunnelName.cfargotunnel.com --url localhost:3389"
          Write-Host "3. 用 RDP 客户端连接 localhost:3389 (或指定端口)"
          Write-Host "================`n"

      - name: Keep workflow alive (wait for manual stop)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          Write-Host "Workflow will stay alive for up to 6 hours."
          Write-Host "Press Ctrl+C in the runner terminal to stop early."
          Write-Host "RDP is accessible via Cloudflared tunnel."

          # 简单心跳，防止超时
          $start = Get-Date
          $timeoutMinutes = 360
          while (((Get-Date) - $start).TotalMinutes -lt $timeoutMinutes) {
            Write-Host "Still alive - $(Get-Date -Format 'HH:mm:ss')"
            Start-Sleep -Seconds 30
          }
          Write-Host "Timeout reached. Workflow will exit."
